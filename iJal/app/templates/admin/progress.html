{% extends 'admin/base.html' %}
{% block title %} Progress {% endblock %}
{% from 'mobile/components.html' import chart, table_title, floating_input, validate_button,
input_hidden,submit_button,progress_bar,tooltip,
search_input,validation_input,badge%}
{% block content %}

{{table_title(title='Validation Progress',subtitle=' ')}}
{{search_input(placeholder='Search Block')}}
<div class="overflow-y-scroll overflow-x-hidden" style="height:70vh !important;">
    <table class="table table-bordered table-sm fs-7 mb-0">
        <thead class="text-center">
            <tr>
                <th style="max-width: 20px;">State</th>
                <th style="max-width: 40px;">District</th>
                <th style="max-width: 40px;">Block</th>
                <th style="max-width: 100px;">Progress</th>
            </tr>
        </thead>
        <tbody id="tablebody">
            {% for row in progress %}
            <tr id="row_{{ row['id'] }}">
                {{ input_hidden(name='id', value=row['id']) }}
                <td class="text-center align-content-center" style="max-width: 20px;">
                    {{ tooltip(name=row['state_short_name'],full_name=row['state_name']) }}
                </td>
                <td class="text-start align-content-center text-truncate" style="max-width: 40px;">
                    {{ tooltip(name=row['district_name']) }}
                </td>
                <td class="text-start align-content-center text-truncate" style="max-width: 40px;">
                    {{ tooltip(name=row['block_name']) }}
                </td>
                <td class="text-center align-content-center" style="max-width: 100px;">
                    <div class="progress-bar-anchor" style="cursor: pointer;">
                        <div class="row">
                            <div class="col-10">
                                {{ progress_bar(completed=row['completed']) }}
                            </div>
                            <div class="col-1 p-0 d-grid align-items-center">
                                <span class="text-center fs-9">
                                    
                                        <i class="fa-solid fa-arrow-up-right-from-square"></i>
                                    
                                </span>
                            </div>
                        </div>
                        
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<input type="hidden" name="progress_data" id="progressData" value="{{progress_data}}">
<input type="hidden" name="redirect_url" id="redirectUrl" value="{{url_for('admin.status')}}">
</div>


{% endblock %}
{% block scripts %}
<script>
    const redirectUrl = document.getElementById('redirectUrl').value;


    document.addEventListener('DOMContentLoaded', function () {
        // Get all the progress bar elements
        const progressBars = document.querySelectorAll('.progress-bar-anchor');

        progressBars.forEach(function (progressBar) {
            // Add event listener for click event
            progressBar.addEventListener('click', function () {
                // Get the row ID from the parent row (using the row's ID attribute)
                const rowId = this.closest('tr').id.replace('row_', ''); // Get the row id without 'row_'
                const progressData = JSON.parse(document.getElementById('progressData').value); // Get all progress data

                // Find the specific row data based on the row ID
                const rowData = progressData.find(item => item.id === parseInt(rowId));

                if (rowData) {
                    // Send the data using a POST request
                    sendProgressData(rowData);
                } else {
                    console.error('Row data not found');
                }
            });
        });
    });

    function sendProgressData(data) {
        // Get the redirect URL dynamically, for example, from a hidden input field or other source
        // Toggle the spinner before sending the request
        toggleSpinner();

        fetch(redirectUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
            .then(response => {
                // Check if the response is successful
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json(); // Parse JSON response
            })
            .then(responseData => {
                // Ensure there is a redirect URL in the response
                if (responseData.redirect_url) {
                    // Toggle the spinner off after receiving the response
                    
                    // Redirect to the provided URL
                    window.location.href = responseData.redirect_url;
                    toggleSpinner();
                } else {
                    // Handle the case where no redirect URL is provided
                    alert("No redirect URL provided.");
                    toggleSpinner();
                }
            })
            .catch(error => {
                // Catch any errors and display an error message
                console.error("Error submitting data:", error);
                alert("An error occurred while submitting data.");
                toggleSpinner(); // Ensure the spinner is stopped on error
            });
    }

    document.getElementById("searchInput").addEventListener("input", function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("#tablebody tr");
        rows.forEach(row => {
            const cropName = row.cells[2].textContent.toLowerCase();
            if (cropName.includes(filter)) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    });
</script>
{% endblock %}