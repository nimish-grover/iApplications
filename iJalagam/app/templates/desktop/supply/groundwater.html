{% extends 'desktop/base.html' %}
{% block title %}Surface{% endblock %}
{% from 'desktop/components.html' import select, block_button, chart,checkbox,steps %}
{% from 'components/user_macros.html' import floating_input, step, select %}

{% block content %}

<section id="section1" class="">
    {{steps(progress=progress)}}

  <div class="row">
    <div class="col-2"></div>
    <div class="col">
      <h5 class="card-title text-center fw-bold">Surface Data</h5>
    </div>
    <div class="col-2 text-end">
      <!-- <a type="button" id="btnNewRow" href="" class="btn btn-sm btn-outline-dark mb-2 btnChangeSection" data-target="section2"><i class="fa-solid fa-plus"></i></a> -->
    </div>
  </div>
  <table class="table table-bordered table-sm fs-7 mb-0">
    <thead class="text-center">
      <tr>
        <th>Extractable</th>
        <th>Extraction</th>
        <th>Stage</th>
        <th>Category</th>
        <th class="hidden">id</th>
        <!-- <th clsss="hidden">b_territory_id</th> -->
        <th></th>
        <!-- <th></th> -->
      </tr>
    </thead>
    <tbody id="tableBody">
      {% for row in gw_data %}
      <tr data-id="{{loop.index0}}">
        <td class="text-end">{{row['extractable']}}</td>
        <td class="text-end">{{row['extraction']}}</td>
        <td class="text-end">{{row['stage_of_extraction']}}</td>
        <td class="text-start">{{row['category']}}</td>
        <td class="hidden">{{row['id']}}</td>
        <td class="hidden">{{row['b_territory_id']}}</td>
        <td class="text-center"><a href="" class="btnEdit btnChangeSection" data-target="section2" style="text-decoration: none;"><i
              class="fa-solid fa-lg fa-pencil"></i></a></td>
        <!-- <td class="text-center"><button class="btn text-danger p-0 btnDelete"><i class="fa-solid fa-xmark"></i></button></td> -->
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% if isApproved %}

  {{checkbox(id='checkBox',label='I declare that above information is correct.')}}
  <div class="d-flex mt-4 mb-2">
    <div class="d-grid gap-2 flex-grow-1 ms-2">
      <button type="button" id="btnSubmit" onclick="toggleSpinner()" class="btn btn-success mb-3 disabled btnSubmit">Update</button>
    </div>
  </div>
  {%else%}
  {{checkbox(id='checkBox',label ='I declare that above data has been validated and updated.')}}

  <div class="d-flex mt-4 mb-2">
    <div class="d-grid gap-2 flex-grow-1 ms-2">
      <button type="button" id="btnSubmit" class="btn btn-success mb-3 disabled btnSubmit">Approve</button>
    </div>
  </div>
  {%endif%}
</section>
<section id="section2" class="hidden">
  <form class="card-body" id="formId">
    <h5 class="card-title text-center fw-bold">Surface Data</h5>
    {{floating_input(id='extraction', label='Extraction')}}
    {{floating_input(id='extractable', label='Extractable')}}
    {{floating_input(id='stage_of_extraction', label='Stage of Extraction')}}
    {{select(id='category', label='Select Category', dd_array=dropdown_data)}}
    <!-- <input type="hidden" category="formData" value=""> -->
    <div class="d-flex">
      <div class="d-grid gap-2 flex-grow-1">
        <a type="button" id="btnCancel" href="" class="btn btn-outline-dark mb-3 btnChangeSection" data-target="section1">Cancel</a>
      </div>
      <div class="d-grid gap-2 flex-grow-1 ms-2">
        <button type="button" id="btnAdd" class="btn btn-primary mb-3 disabled btnChangeSection">Add</button>
      </div>
    </div>
  </form>
</section>

{% endblock %}
{% block scripts %}



<script>
document.addEventListener('DOMContentLoaded', function () {
    // DOM Elements
    const tableBody = document.getElementById('tableBody');
    const groundCategory = document.getElementById('select_category');
    const groundExtraction = document.getElementById('input_extraction');
    const groundExtractable = document.getElementById('input_extractable');
    const groundStage = document.getElementById('input_stage_of_extraction');
    const addButton = document.getElementById('btnAdd');
    const approveButton = document.getElementById('btnSubmit');
    const cancelButton = document.getElementById('btnCancel');
    const checkBox = document.getElementById('checkBox');
    
    // State Variables
    let rows = [];
    let editingRowId = null;

    // Initialize table rows
    function initializeRows() {
        const tableRows = Array.from(tableBody.querySelectorAll("tr"));
        rows = tableRows.map(row => {
    const id = row.getAttribute("data-id");
    const cells = row.querySelectorAll("td");
    return {
        extractable: parseFloat(cells[0].innerText).toFixed(2),
        extraction: parseFloat(cells[1].innerText).toFixed(2),
        stage: parseFloat(cells[2].innerText).toFixed(2),
        category: cells[3].querySelector('select') 
            ? cells[3].querySelector('select').selectedOptions[0].text.trim() 
            : cells[3].innerText.trim(),
        db_id: parseInt(cells[4].innerText, 10),
        b_territory_id: parseInt(cells[5].innerText, 10)
    };
});

        console.log(rows);
    }

    // Render Table
    function renderTable() {
        console.log('Rendering table with rows:', rows);  // Log to see rows before rendering

        tableBody.innerHTML = rows.map((row, index) => `
            <tr data-id="${index}">
                <td class="text-end">${row.extractable}</td>
                <td class="text-end">${row.extraction}</td>
                <td class="text-end">${row.stage}</td>
                <td class="text-start">${row.category}</td>
                <td class="hidden">${row.db_id}</td>
                <td class="hidden">${row.b_territory_id}</td>
                <td class="text-center">
                    <a href="#" class="btnEdit btnChangeSection" style="text-decoration: none;">
                        <i class="fa-solid fa-lg fa-pencil"></i>
                    </a>
                </td>

            </tr>
        `).join("");
        attachEditListeners();
        // attachDeleteListeners();
    }

    // Attach Edit Button Listeners
    function attachEditListeners() {
        const editButtons = document.querySelectorAll('.btnEdit');
        editButtons.forEach(button => {
            button.removeEventListener('click', handleEdit); // Remove existing listener to avoid duplication
            button.addEventListener('click', handleEdit); // Add the click event listener for edit button
        });
    }

    // Attach Delete Button Listeners
    // function attachDeleteListeners() {
    //     const deleteButtons = document.querySelectorAll('.btnDelete');
    //     deleteButtons.forEach(button => {
    //         button.removeEventListener('click', handleDelete); // Remove existing listener to avoid duplication
    //         button.addEventListener('click', handleDelete); // Add the click event listener for delete button
    //     });
    // }

    // Handle Edit
    function handleEdit(event) {
        event.preventDefault();
        const row = this.closest('tr');
        const rowId = parseInt(row.getAttribute('data-id'), 10);
        const selectedRow = rows[rowId];

        // Populate form with row data
        const matchingOption = Array.from(groundCategory.options).find(option => option.text === selectedRow.category);
        console.log(matchingOption);
        console.log(selectedRow.category);
        if (matchingOption) {
            groundCategory.value = matchingOption.value;
        } else {
            groundCategory.selectedIndex = 0;
        }
        
        groundExtraction.value = selectedRow.extraction;
        groundExtractable.value = selectedRow.extractable;
        groundStage.value = selectedRow.stage;
        editingRowId = rowId;

        // Validate and update Add button state
        validateForm();
        updateAddButton();
        initializeSectionSwitching();
        switchSection('section2');
    }

    // Handle Delete
    // function handleDelete(event) {
    //     event.preventDefault();
    //     const row = this.closest('tr');
    //     const rowId = parseInt(row.getAttribute('data-id'), 10);

    //     // Remove the row from the array
    //     rows = rows.filter((_, index) => index !== rowId);

    //     // Log rows to check if the array is updated
    //     console.log('Rows after delete:', rows);

    //     // Re-render the table
    //     renderTable();
    //     updateApproveButton();
    // }

    // Add or Update Row
    function handleAdd() {
        const category = groundCategory.options[groundCategory.selectedIndex].text;
        const extraction = parseFloat(groundExtraction.value).toFixed(2);
        const extractable = parseFloat(groundExtractable.value).toFixed(2);
        const stage = parseFloat(groundStage.value).toFixed(2);
        const db_id = editingRowId !== null ? rows[editingRowId].db_id : null;
        const b_territory_id = editingRowId !== null ? rows[editingRowId].b_territory_id : null;

        // Check for duplicates by population type category (update the groundExtraction of the row if exists)
        const existingRow = rows.find((row, index) => row.category === category && index !== editingRowId);
        if (existingRow) {
            // console.log('Updating existing row with category:', category);
            existingRow.extraction = extraction;  // Update the groundExtraction of the existing row
            existingRow.extractable = extractable;
            existingRow.stage = stage;
            existingRow.category = category;
        } else {
            console.log('Adding new row:', category);
            if (editingRowId !== null) {
                // Update existing row
                rows[editingRowId] = {extraction,extractable,stage,category,db_id,b_territory_id };
                editingRowId = null;
            } else {
                // Add new row
                rows.push({extraction,extractable,stage,category,db_id,b_territory_id  });
            }
        }

        // Log rows to check if the array is updated
        console.log('Rows after add/edit:', rows);

        renderTable();
        resetForm();
        updateApproveButton();
        initializeSectionSwitching();
        switchSection('section1');
    }

    function handleApprove() {
    if (checkBox.checked && rows.length > 0) {
        const payload = rows;
        console.log('Sending data to server:', payload);

        toggleSpinner(true); // Show spinner before sending the request

        fetch('{{url_for("desktop.ground")}}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Request failed with status ${response.status}`);
                }
                return response.json(); // Expecting a JSON response
            })
            .then(data => {
                console.log('Data submitted successfully:', data);

                // Clear the table and reset the form
                // renderTable();
                // resetForm();
                // updateApproveButton();

                // Perform redirection
                if (data.redirect_url) {
                    console.log('Redirecting to:', data.redirect_url);
                    window.location.href = data.redirect_url; // Redirect to the provided URL
                } else {
                    console.warn('No redirect URL provided in the response.');
                }
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                toggleSpinner(false); // Hide spinner regardless of success or failure
            });
    } else {
        console.log('Cannot submit, either checkbox is unchecked or no rows available');
    }
}



    // Reset Form
    function resetForm() {
        groundCategory.selectedIndex = 0;
        groundExtraction.value = "";
        groundExtractable.value = "";
        groundStage.value = "";
        groundStage.classList.remove('is-valid', 'is-invalid');
        groundCategory.classList.remove('is-valid', 'is-invalid');
        groundExtraction.classList.remove('is-valid', 'is-invalid');
        groundExtractable.classList.remove('is-valid', 'is-invalid');
        editingRowId = null;
        updateAddButton();
    }

    // Validation Functions
    function validateCategory() {
    const isValid = groundCategory.value !== "" && groundCategory.selectedIndex !== 0;
    groundCategory.classList.toggle('is-valid', isValid);
    groundCategory.classList.toggle('is-invalid', !isValid);
    return isValid;
}


    function validateExtraction() {
        const extraction = parseFloat(groundExtraction.value);
        const isValid = !isNaN(extraction) && extraction >= 0;
        groundExtraction.classList.toggle('is-valid', isValid);
        groundExtraction.classList.toggle('is-invalid', !isValid);
        return isValid;
    }
    
    function validateStage() {
        const stage = parseFloat(groundStage.value);
        const isValid = !isNaN(stage) && stage >= 0;
        groundStage.classList.toggle('is-valid', isValid);
        groundStage.classList.toggle('is-invalid', !isValid);
        return isValid;
    }
    function validatExtractable() {
        const extractable = parseFloat(groundExtractable.value);
        const isValid = !isNaN(extractable) && extractable >= 0;
        groundExtractable.classList.toggle('is-valid', isValid);
        groundExtractable.classList.toggle('is-invalid', !isValid);
        return isValid;
    }

    function validateForm() {
        return validateCategory() && validateExtraction() && validatExtractable() && validateStage();
    }

    function updateAddButton() {
        const isValid = validateForm();
        addButton.disabled = !isValid;
        addButton.classList.toggle('disabled', !isValid);
    }

    function updateApproveButton() {
        const hasRows = rows.length > 0;
        const isCheckboxChecked = checkBox.checked;
        approveButton.disabled = !(isCheckboxChecked && hasRows);
        approveButton.classList.toggle('disabled', !(isCheckboxChecked && hasRows));
    }

    // Event Listeners
    groundCategory.addEventListener('change', updateAddButton);
    groundExtraction.addEventListener('input', updateAddButton);
    groundExtractable.addEventListener('input',updateAddButton);
    groundStage.addEventListener('input',updateAddButton);
    addButton.addEventListener('click', (e) => {
        e.preventDefault();
        handleAdd();
    });
    cancelButton.addEventListener('click', (e) => {
        e.preventDefault();
        resetForm();
        initializeSectionSwitching();
        switchSection('section1');
    });
    checkBox.addEventListener('change', updateApproveButton);
    approveButton.addEventListener('click', handleApprove);

    // Initial Setup
    initializeRows();
    renderTable();
});


</script>






{%endblock%}