{% extends 'desktop/base.html' %}
{% block title %}Rainfall{% endblock %}
{% from 'desktop/components.html' import select, block_button, chart %}
{% from 'components/user_macros.html' import floating_input, step, select %}
{% block content %}
<section id="section1" class="">
    <h5 class="card-title text-center fw-bold">Surface Water Supply</h5>
    <table class="table table-bordered table-sm fs-7 mb-0">
        <thead class="text-center">
            <tr>
                <th>S.No.</th>
                <th>Observation Month</th>
                <th>Normal</th>
                <th>Actual</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            {% for rainfall in monthwise_rainfall %}
            <tr>
                <td class="text-center p-0">{{loop.index}}</td>
                <td class="text-start p-0 ps-1">{{rainfall.month}}</td>
                <td class="text-center p-0">{{rainfall.normal}}</td>
                <td class="text-center p-0">{{rainfall.actual}}</td>
                <td class="text-center"><a href="" class="btnChangeSection" style="text-decoration: none;"><i
                    class="fa-solid fa-pen-to-square"></i></a></i></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</section>
<section id="section2" class="hidden">
    <form class="card-body" id="formId">
        <h5 class="card-title text-center fw-bold">Surface Water Supply</h5>
        {{select(id='month', label='Select Month', dd_array=dropdown_data)}}
        {{floating_input(id='year', label='Year')}}
        {{floating_input(id='normal', label='Normal')}}
        {{floating_input(id='actual', label='Actual')}}
        <div class="text-center">
            <button type="button" class="btn btn-outline-dark mb-3" id="btnAdd" disabled>Add</button>
        </div>
        <table class="table table-bordered table-sm fs-7">
            <thead>
                <tr class="text-center">
                    <th>S.No.</th>
                    <th>Observation Month</th>
                    <th>Normal</th>
                    <th>Actual</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="table-body">
            <!--Placeholder for dynamic table-->
            </tbody>
            <tfoot>
                <tr>
                  <td colspan="2">Total</td>
                  <td id="total-normal" class="text-end">0</td>
                  <td id="total-actual" class="text-end">0</td>
                  <td></td>
                </tr>
              </tfoot>
        </table>
        <!-- <input type="hidden" name="formData" value=""> -->
        <div class="d-flex">
            <div class="d-grid gap-2">
                <a type="button" href="" class="btn btn-outline-dark mb-3 btnChangeSection">Cancel</a>
            </div>
            <div class="d-grid gap-2 flex-grow-1 ms-2">
                <button type="button" id="btnSubmit" class="btn btn-primary mb-3 disabled btnChangeSection">Submit</button>
            </div>
       </div>        
      </form>
</section>

{% endblock %}
{% block scripts %}
<script>

    // Select all buttons with the class 'btnChangeSection'
    const buttons = document.querySelectorAll('.btnChangeSection');

    buttons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            toggleSpinner(); // Show spinner before transition

            const section1 = document.getElementById('section1');
            const section2 = document.getElementById('section2');

            // Simulate a delay for the transition (e.g., for animations)
            setTimeout(() => {
                // Toggle visibility of sections
                if (section1.classList.contains('hidden')) {
                    section1.classList.remove('hidden');
                    section2.classList.add('hidden');
                } else {
                    section1.classList.add('hidden');
                    section2.classList.remove('hidden');
                }
                toggleSpinner(); // Hide spinner after transition
            }, 500); // Adjust the timeout duration as needed
        });
    });
</script>
<script>
    const tableBody = document.getElementById("table-body");
    const totalWaterbodyElement = document.getElementById("total-month");
    const month = document.getElementById("select_month");
    const year = document.getElementById("input_year");
    const actual = document.getElementById("input_actual");
    const normal = document.getElementById("input_normal");
    const addButton = document.getElementById("btnAdd");
    const submitButton = document.getElementById("btnSubmit");

    const rows = [];
    month.focus();

    function validateField(input, condition) {
        if (condition) {
            input.classList.remove("is-invalid");
            input.classList.add("is-valid");
            return true;
        } else {
            input.classList.add("is-invalid");
            input.classList.remove("is-valid");
            return false;
        }
    }

    function enableAddButton() {
        const monthValid = month.selectedIndex !== 0;
        const yearValid = parseInt(year.value) > 2000 && !isNaN(year.value);
        const actualValid = !isNaN(parseFloat(actual.value)) && parseFloat(actual.value) > 0;
        const normalValid = !isNaN(parseFloat(normal.value)) && parseFloat(normal.value) > 0;

        if (monthValid && yearValid && actualValid && normalValid) {
            addButton.removeAttribute('disabled');
        } else {
            addButton.setAttribute('disabled', 'disabled');
        }
    }

    function validateMonth() {
        return validateField(month, month.selectedIndex !== 0);
    }

    function validateYear() {
        const yearValid = parseInt(year.value) > 2000 && !isNaN(year.value);
        return validateField(year, yearValid);
    }

    function validateActual() {
        const actualValid = !isNaN(parseFloat(actual.value)) && parseFloat(actual.value) > 0;
        return validateField(actual, actualValid);
    }

    function validateNormal() {
        const normalValid = !isNaN(parseFloat(normal.value)) && parseFloat(normal.value) > 0;
        return validateField(normal, normalValid);
    }

    function enablesubmitButton() {
        if (rows.length > 0) {
            submitButton.classList.remove('disabled');
        } else {
            submitButton.classList.add('disabled');
        }
    }

    function updateTotalCount() {
        const totalArea = rows.reduce((sum, row) => sum + parseFloat(row.actual), 0);
        const totalStorage = rows.reduce((sum, row) => sum + parseFloat(row.normal), 0);

        document.getElementById("total-actual").textContent = totalArea.toFixed(2);
        document.getElementById("total-normal").textContent = totalStorage.toFixed(2);
    }

    function resetInputs() {
        month.selectedIndex = 0;
        year.value = "";
        actual.value = "";
        normal.value = "";
        month.classList.remove("is-valid", "is-invalid");
        year.classList.remove("is-valid", "is-invalid");
        actual.classList.remove("is-valid", "is-invalid");
        normal.classList.remove("is-valid", "is-invalid");
    }

    function addRowToTable(row) {
        const existingRow = [...tableBody.children].find(
            (tr) => tr.querySelector("td:nth-child(2)").textContent === row.month_year
        );
        if (existingRow) {
            existingRow.querySelector("td:nth-child(2)").textContent = row.month_year;
            existingRow.querySelector("td:nth-child(4)").textContent = row.actual.toFixed(2);
            existingRow.querySelector("td:nth-child(3)").textContent = row.normal.toFixed(2);
        } else {
            const tr = document.createElement("tr");

            tr.innerHTML = `
                <td class="text-center">${row.serial + 1}</td>
                <td>${row.month_year}</td>
                <td class="text-end">${row.normal.toFixed(2)}</td>
                <td class="text-end">${row.actual.toFixed(2)}</td>
                <td class="text-center"><button class="btn text-danger p-0" data-index="${row.serial}"><i class="fa-regular fa-circle-xmark"></i></button></td>
            `;

            tableBody.appendChild(tr);
        }
    }

    addButton.addEventListener("click", () => {
        const monthOption = month.options[month.selectedIndex];
        const month_text = monthOption.text;
        const month_value = monthOption.value;
        const yearValue = parseInt(year.value);
        const actualValue = parseFloat(actual.value);
        const normalValue = parseFloat(normal.value);

        // Combine month and year as 'Jan-24'
        const month_year = `${month_text.slice(0, 3)}-${yearValue.toString().slice(-2)}`;

        const existing = rows.find((row) => row.month_year === month_year);

        if (existing) {
            existing.year = yearValue;
            existing.actual = actualValue;
            existing.normal = normalValue;
            existing.month_year = month_year;
            addRowToTable(existing);
        } else {
            const newRow = {
                serial: rows.length,
                month_year: month_year,
                actual: actualValue,
                normal: normalValue
            };
            rows.push(newRow);
            addRowToTable(newRow);
        }

        updateTotalCount();
        resetInputs();
        enablesubmitButton();
    });

    tableBody.addEventListener("click", (e) => {
        if (e.target.closest(".btn.text-danger")) {
            const deleteButton = e.target.closest(".btn.text-danger");
            const index = parseInt(deleteButton.dataset.index, 10);

            rows.splice(index, 1);
            tableBody.innerHTML = "";
            rows.forEach((row, idx) => {
                row.serial = idx;
                addRowToTable(row);
            });

            updateTotalCount();
            enablesubmitButton();
        }
    });

    month.addEventListener("change", () => {
        validateMonth();
        enableAddButton();
    });

    year.addEventListener("input", () => {
        validateYear();
        enableAddButton();
    });

    actual.addEventListener("input", () => {
        validateActual();
        enableAddButton();
    });

    normal.addEventListener("input", () => {
        validateNormal();
        enableAddButton();
    });

    submitButton.addEventListener("click", (event) => {
        event.preventDefault();
        toggleSpinner();
        const url = "{{url_for('desktop.rainfall')}}";
        const payload = rows;
        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        }).then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        }).then(data => {
            window.location.href = data['redirect_to'];
        }).catch(error => {
            toggleSpinner();
            console.error('Error:', error);
        });
    });
</script>
    
{%endblock%}