{% extends 'desktop/base.html' %}
{% block title %}Industry{% endblock %}
{% from 'desktop/components.html' import select, block_button, chart,checkbox,steps %}
{% from 'components/user_macros.html' import floating_input, step, select %}

{% block content %}

<section id="section1" class="">
    {{steps(progress=progress)}}

    <div class="row">
        <div class="col-2"></div>
        <div class="col">
            <h5 class="card-title text-center fw-bold">Industry Data</h5>
        </div>
        <div class="col-2 text-end">
            <a type="button" id="btnNewRow" href="" class="btn btn-sm btn-outline-dark mb-2 btnChangeSection"
                data-target="section2"><i class="fa-solid fa-plus"></i></a>
        </div>
    </div>
    <table class="table table-bordered table-sm fs-7 mb-0">
        <thead class="text-center">
            <tr>
                <th>S.No.</th>
                <th>Description</th>
                <th>Annual Allocation</th>
                <th>Unit</th>
                <th class="hidden">id</th>
                <!-- <th clsss="hidden">b_territory_id</th> -->
                <th></th>
                <!-- <th></th> -->
            </tr>
        </thead>
        <tbody id="tableBody">
            {% for row in industries %}
            <tr data-id="{{loop.index0}}">
                <td class="text-center">{{loop.index}}</td>
                <td class="text-start">{{row['industry']}}</td>
                <td class="text-end">{{row['allocation_value']}}</td>
                <td class="text-start">{{row['unit_value']}}</td>
                <td class="hidden">{{row['id']}}</td>
                <td class="hidden">{{row['b_territory_id']}}</td>
                <td class="text-center"><a href="" class="btnEdit btnChangeSection" data-target="section2"
                        style="text-decoration: none;"><i class="fa-solid fa-lg fa-pencil"></i></a></td>
                <!-- <td class="text-center"><button class="btn text-danger p-0 btnDelete"><i class="fa-solid fa-xmark"></i></button></td> -->
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% if isApproved %}

    {{checkbox(id='checkBox',label='I declare that above information is correct.')}}
    <div class="d-flex mt-4 mb-2">
        <div class="d-grid gap-2 flex-grow-1 ms-2">
            <button type="button" id="btnSubmit" onclick="toggleSpinner()"
                class="btn btn-success mb-3 disabled btnSubmit">Update</button>
        </div>
    </div>
    {%else%}
    {{checkbox(id='checkBox',label ='I declare that above data has been validated and updated.')}}

    <div class="d-flex mt-4 mb-2">
        <div class="d-grid gap-2 flex-grow-1 ms-2">
            <button type="button" id="btnSubmit" class="btn btn-success mb-3 disabled btnSubmit">Approve</button>
        </div>
    </div>
    {%endif%}
</section>
<section id="section2" class="hidden">
    <form class="card-body" id="formId">
        <h5 class="card-title text-center fw-bold">Human Data</h5>
        {{select(id='industry_type', label='Select Industry Type', dd_array=dropdown_data)}}
        {{floating_input(id='allocation', label='Annual Allocation')}}
        {{select(id='unit', label='Select Unit', dd_array=units)}}

        <!-- <input type="hidden" industry="formData" value=""> -->
        <div class="d-flex">
            <div class="d-grid gap-2 flex-grow-1">
                <a type="button" id="btnCancel" href="" class="btn btn-outline-dark mb-3 btnChangeSection"
                    data-target="section1">Cancel</a>
            </div>
            <div class="d-grid gap-2 flex-grow-1 ms-2">
                <button type="button" id="btnAdd" class="btn btn-primary mb-3 disabled btnChangeSection">Add</button>
            </div>
        </div>
    </form>
</section>

{% endblock %}
{% block scripts %}



<script>
    document.addEventListener('DOMContentLoaded', function () {
        // DOM Elements
        const tableBody = document.getElementById('tableBody');
        const industryType = document.getElementById('select_industry_type');
        const allocation = document.getElementById('input_allocation');
        const unit = document.getElementById('select_unit');
        const addButton = document.getElementById('btnAdd');
        const approveButton = document.getElementById('btnSubmit');
        const cancelButton = document.getElementById('btnCancel');
        const checkBox = document.getElementById('checkBox');

        // State Variables
        let rows = [];
        let editingRowId = null;

        // Initialize table rows
        function initializeRows() {
            const tableRows = Array.from(tableBody.querySelectorAll("tr"));
            rows = tableRows.map(row => {
                const id = row.getAttribute("data-id");
                const cells = row.querySelectorAll("td");
                return {
                    id: parseInt(id),
                    industry: cells[1].innerText,
                    allocation_value: parseInt(cells[2].innerText, 10),
                    unit_value: cells[3].innerText,
                    db_id: parseInt(cells[4].innerText, 10),
                    b_territory_id: parseInt(cells[5].innerText, 10)
                };
            });
            console.log(rows);
        }

        // Render Table
        function renderTable() {
            console.log('Rendering table with rows:', rows);  // Log to see rows before rendering

            tableBody.innerHTML = rows.map((row, index) => `
            <tr data-id="${index}">
                <td class="text-center">${index + 1}</td>
                <td class="text-start">${row.industry}</td>
                <td class="text-end">${row.allocation_value}</td>
                <td class="text-start">${row.unit_value}</td>
                <td class="hidden">${row.db_id}</td>
                <td class="hidden">${row.b_territory_id}</td>
                <td class="text-center">
                    <a href="#" class="btnEdit btnChangeSection" style="text-decoration: none;">
                        <i class="fa-solid fa-lg fa-pencil"></i>
                    </a>
                </td>

            </tr>
        `).join("");
            attachEditListeners();
            // attachDeleteListeners();
        }

        // Attach Edit Button Listeners
        function attachEditListeners() {
            const editButtons = document.querySelectorAll('.btnEdit');
            editButtons.forEach(button => {
                button.removeEventListener('click', handleEdit); // Remove existing listener to avoid duplication
                button.addEventListener('click', handleEdit); // Add the click event listener for edit button
            });
        }

        // Attach Delete Button Listeners
        // function attachDeleteListeners() {
        //     const deleteButtons = document.querySelectorAll('.btnDelete');
        //     deleteButtons.forEach(button => {
        //         button.removeEventListener('click', handleDelete); // Remove existing listener to avoid duplication
        //         button.addEventListener('click', handleDelete); // Add the click event listener for delete button
        //     });
        // }

        // Handle Edit
        function handleEdit(event) {
            event.preventDefault();
            const row = this.closest('tr');
            const rowId = parseInt(row.getAttribute('data-id'), 10);
            const selectedRow = rows[rowId];

            // Populate form with row data
            const matchingOption = Array.from(industryType.options).find(option => option.text === selectedRow.industry);
            const matchingUnit = Array.from(unit.options).find(option => option.text === selectedRow.unit_value);
            if (matchingOption) {
                industryType.value = matchingOption.value;
            } else {
                industryType.selectedIndex = 0;
            }
            if (matchingUnit) {
                unit.value = matchingUnit.value;
            } else {
                unit.selectedIndex = 0;
            }

            allocation.value = selectedRow.allocation_value;
            editingRowId = rowId;

            // Validate and update Add button state
            validateForm();
            updateAddButton();
            initializeSectionSwitching();
            switchSection('section2');
        }

        // Handle Delete
        // function handleDelete(event) {
        //     event.preventDefault();
        //     const row = this.closest('tr');
        //     const rowId = parseInt(row.getAttribute('data-id'), 10);

        //     // Remove the row from the array
        //     rows = rows.filter((_, index) => index !== rowId);

        //     // Log rows to check if the array is updated
        //     console.log('Rows after delete:', rows);

        //     // Re-render the table
        //     renderTable();
        //     updateApproveButton();
        // }

        // Add or Update Row
        function handleAdd() {
            const industry = industryType.options[industryType.selectedIndex].text;
            const unit_value = unit.options[unit.selectedIndex].text;
            const allocation_value = parseInt(allocation.value, 10);
            const db_id = editingRowId !== null ? rows[editingRowId].db_id : rows.length + 1;
            const b_territory_id = editingRowId !== null ? rows[editingRowId].b_territory_id : rows.length + 1;

            // Check for duplicates by population type industry (update the allocation_value of the row if exists)
            const existingRow = rows.find((row, index) => row.industry === industry && index !== editingRowId);
            if (existingRow) {
                console.log('Updating existing row with industry:', industry);
                existingRow.allocation_value = allocation_value;  // Update the allocation of the existing row
                existingRow.unit_value = unit_value;
            } else {
                console.log('Adding new row:', industry);
                if (editingRowId !== null) {
                    // Update existing row
                    rows[editingRowId] = { id: editingRowId, industry, allocation_value, unit_value, db_id, b_territory_id };
                    editingRowId = null;
                } else {
                    // Add new row
                    rows.push({ id: rows.length, industry, allocation_value, unit_value, db_id, b_territory_id });
                }
            }

            // Log rows to check if the array is updated
            console.log('Rows after add/edit:', rows);

            renderTable();
            resetForm();
            updateApproveButton();
            initializeSectionSwitching();
            switchSection('section1');
        }

        function handleApprove() {
            if (checkBox.checked && rows.length > 0) {
                const payload = rows;
                console.log('Sending data to server:', payload);

                toggleSpinner(true); // Show spinner before sending the request

                fetch('{{url_for("desktop.industry")}}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Request failed with status ${response.status}`);
                        }
                        return response.json(); // Expecting a JSON response
                    })
                    .then(data => {
                        console.log('Data submitted successfully:', data);

                        // Clear the table and reset the form
                        // renderTable();
                        // resetForm();
                        // updateApproveButton();

                        // Perform redirection
                        if (data.redirect_url) {
                            console.log('Redirecting to:', data.redirect_url);
                            window.location.href = data.redirect_url; // Redirect to the provided URL
                        } else {
                            console.warn('No redirect URL provided in the response.');
                        }
                    })
                    .catch(error => console.error('Error:', error))
                    .finally(() => {
                        toggleSpinner(false); // Hide spinner regardless of success or failure
                    });
            } else {
                console.log('Cannot submit, either checkbox is unchecked or no rows available');
            }
        }



        // Reset Form
        function resetForm() {
            industryType.selectedIndex = 0;
            unit.selectedIndex = 0;
            allocation.value = "";
            industryType.classList.remove('is-valid', 'is-invalid');
            allocation.classList.remove('is-valid', 'is-invalid');
            unit.classList.remove('is-valid','is-invalid');
            editingRowId = null;
            updateAddButton();
        }

        // Validation Functions
        function validatePopulationType() {
            const isValid = industryType.value !== "";
            industryType.classList.toggle('is-valid', isValid);
            industryType.classList.toggle('is-invalid', !isValid);
            return isValid;
        }
        function validateUnit() {
            const isValid = unit.value !== "" && unit.selectedIndex !== 0;
            unit.classList.toggle('is-valid', isValid);
            unit.classList.toggle('is-invalid', !isValid);
            return isValid;
        }

        function validateCount() {
            const allocationValue = parseInt(allocation.value, 10);
            const isValid = !isNaN(allocationValue) && allocationValue > 0;
            allocation.classList.toggle('is-valid', isValid);
            allocation.classList.toggle('is-invalid', !isValid);
            return isValid;
        }

        function validateForm() {
            return validatePopulationType() && validateCount() && validateUnit();
        }

        function updateAddButton() {
            const isValid = validateForm();
            addButton.disabled = !isValid;
            addButton.classList.toggle('disabled', !isValid);
        }

        function updateApproveButton() {
            const hasRows = rows.length > 0;
            const isCheckboxChecked = checkBox.checked;
            approveButton.disabled = !(isCheckboxChecked && hasRows);
            approveButton.classList.toggle('disabled', !(isCheckboxChecked && hasRows));
        }

        // Event Listeners
        industryType.addEventListener('change', updateAddButton);
        allocation.addEventListener('input', updateAddButton);
        unit.addEventListener('change', updateAddButton);
        addButton.addEventListener('click', (e) => {
            e.preventDefault();
            handleAdd();
        });
        cancelButton.addEventListener('click', (e) => {
            e.preventDefault();
            resetForm();
            initializeSectionSwitching();
            switchSection('section1');
        });
        checkBox.addEventListener('change', updateApproveButton);
        approveButton.addEventListener('click', handleApprove);

        // Initial Setup
        initializeRows();
        renderTable();
    });


</script>






{%endblock%}