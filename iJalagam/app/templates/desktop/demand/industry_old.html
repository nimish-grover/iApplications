{% extends 'desktop/base.html' %}
{% block title %}Human{% endblock %}
{% from 'desktop/components.html' import select, block_button, chart %}
{% from 'components/user_macros.html' import floating_input, step, select, select_unit %}
{% block content %}
<section id="section1" class="">
    <h5 class="card-title text-center fw-bold">Human Consumption</h5>
    <table class="table table-bordered table-sm fs-7 mb-0">
        <thead class="text-center">
            <tr>
                <th>S.No.</th>
                <th>Description</th>
                <th>Water Allocation</th>
                <th>Consumption</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            
            <tr>
                <td class="text-center">1</td>
                <td>Hospitality Sector</td>
                <td class="text-end">1 MLD</td>
                <td class="text-end">2.5</td>
                <td class="text-center"><a href="" class="btnChangeSection" style="text-decoration: none;"><i
                            class="fa-solid fa-pen-to-square"></i></a></i></td>
            </tr>
            
        </tbody>
    </table>
</section>
<section id="section2" class="hidden">
    <form class="card-body" id="formId">
        <h5 class="card-title text-center fw-bold">Industry Consumption</h5>
        {{select(id='industry_sector', label='Select Sector', dd_array=dropdown_data)}}
        {{ floating_input(id='annual_allocation', label='Annual Water Allocation')}}
        {{select_unit()}}
        <div class="text-center">
            <button type="button" class="btn btn-outline-dark mb-3" id="btnAdd" disabled>Add</button>
        </div>
        <table class="table table-bordered table-sm fs-7">
            <thead>
                <tr class="text-center">
                    <th>S.No.</th>
                    <th>Description</th>
                    <th>Water Allocation</th>
                    <th></th>
                </tr>
            </thead>
            <tbody id="table-body">
            <!--Placeholder for dynamic table-->
            </tbody>
            <tfoot>
                <tr>
                  <td colspan="2">Total Allocation</td>
                  <td id="total-allocation" class="text-end">0</td>
                  <td></td>
                </tr>
              </tfoot>
        </table>
        <!-- <input type="hidden" name="formData" value="> -->
        <div class="d-flex">
            <div class="d-grid gap-2">
                <a type="button" href="" class="btn btn-outline-dark mb-3 btnChangeSection">Cancel</a>
            </div>
            <div class="d-grid gap-2 flex-grow-1 ms-2">
                <button type="button" id="btnSubmit" class="btn btn-primary mb-3 disabled btnChangeSection">Submit</button>
            </div>
       </div>        
      </form>
</section>

{% endblock %}
{% block scripts %}
<script>

    // Select all buttons with the class 'btnChangeSection'
    const buttons = document.querySelectorAll('.btnChangeSection');

    buttons.forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            toggleSpinner(); // Show spinner before transition

            const section1 = document.getElementById('section1');
            const section2 = document.getElementById('section2');

            // Simulate a delay for the transition (e.g., for animations)
            setTimeout(() => {
                // Toggle visibility of sections
                if (section1.classList.contains('hidden')) {
                    section1.classList.remove('hidden');
                    section2.classList.add('hidden');
                } else {
                    section1.classList.add('hidden');
                    section2.classList.remove('hidden');
                }
                toggleSpinner(); // Hide spinner after transition
            }, 500); // Adjust the timeout duration as needed
        });
    });
</script>
<script>
    // Dynamic table creation and deletion
    const tableBody = document.getElementById("table-body");
    const totalAllocationElement = document.getElementById("total-allocation");
    const industryInput = document.getElementById("select_industry_sector");
    const allocationInput = document.getElementById("input_annual_allocation");
    const unitSelect = document.getElementById("select_unit");
    const addButton = document.getElementById("btnAdd");
    const nextButton = document.getElementById("btnSubmit");

    const rows = [];

    industryInput.focus();

    function validateField(input, condition) {
        if (condition) {
            input.classList.remove("is-invalid");
            input.classList.add("is-valid");
            enableAddButton();
            return true;
        } else {
            input.classList.add("is-invalid");
            input.classList.remove("is-valid");
            enableAddButton();
            return false;
        }
        
        }
    
    function enableAddButton(){
        const industry = industryInput.selectedIndex;
        const allocation = parseFloat(allocationInput.value);
        const unit = unitSelect.selectedIndex;

        // Input validation
        if (industry==="0" || allocation <= 0 || isNaN(allocation) || unit === "0") {
            addButton.setAttribute('disabled','disabled');
        } else {
            addButton.removeAttribute('disabled');
        }
    }
    function validateIndustry() {
    return validateField(industryInput, industryInput.selectedIndex !== 0);
    }

    function validateAllocation() {
    const allocation = parseFloat(allocationInput.value);
    return validateField(allocationInput, !isNaN(allocation) && allocation > 0);
    }

    function validateUnit() {
    return validateField(unitSelect, unitSelect.selectedIndex !== 0);
    }

    function enableNextButton(rows) {
        if (rows.length > 0){ 
          nextButton.classList.remove('disabled');
        } 
        else {
          nextButton.classList.add('disabled');
      }
    }

    function updateTotalAllocation() {
      const total = rows.reduce((sum, row) => sum + parseFloat(row.allocation), 0);
      totalAllocationElement.textContent = total.toFixed(2);
    }

    function resetInputs() {
      industryInput.selectedIndex = 0;
      allocationInput.value = "";
      unitSelect.selectedIndex = 0;
      industryInput.classList.remove("is-valid", "is-invalid"); 
      allocationInput.classList.remove("is-valid", "is-invalid"); 
      unitSelect.classList.remove("is-valid", "is-invalid"); 
    }

    function addRowToTable(row) {
      // const rowIndex = rows.length - 1;
      // Find if row with the same industry already exists
      const existingRow = [...tableBody.children].find(
        (tr) => tr.querySelector("td:nth-child(2)").textContent === row.industry
      );
      if (existingRow) {
        // Update the existing row
        existingRow.querySelector("td:nth-child(3)").textContent = row.allocation;
      } else {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="text-center">${row.serial + 1}</td>
          <td>${row.industry}</td>
          <td class="text-end">${row.allocation}</td>
          <td class="text-center"><button class="btn text-danger p-0" data-index="${row.serial}"><i class="fa-regular fa-circle-xmark"></i></button></td>
        `;

        tableBody.appendChild(tr);
      }
    }

    addButton.addEventListener("click", () => {
      const industryOption = industryInput.options[industryInput.selectedIndex];
      const industry_text = industryOption.text;
      const allocation = parseFloat(allocationInput.value);
      const unit = unitSelect.value;
      const unitOption = unitSelect.options[unitSelect.selectedIndex];
      const unit_value = unitOption.text
      const sector_id = industryOption.value

      // Prevent duplicates
      const existing = rows.find((row) => row.industry === industry_text);

      if (existing) {
        // Update the existing row in rows array
        existing.allocation = allocation;
        existing.unit = unit;
        addRowToTable(existing); // Update row in the table
      } else {
        // Add new row
        const newRow = { serial: rows.length, industry: industry_text, allocation, unit:unit_value,sector_id:sector_id };
        rows.push(newRow);
        addRowToTable(newRow); // Add new row to the table
      }

      updateTotalAllocation();
      resetInputs();
      enableNextButton(rows);
    });

    tableBody.addEventListener("click", (e) => {
      if (e.target.closest(".btn.text-danger")) {
        const deleteButton = e.target.closest(".btn.text-danger");
        const index = parseInt(deleteButton.dataset.index, 10);

        // Remove the row from data and DOM
        rows.splice(index, 1);

        // Re-render the table to update row numbers
        tableBody.innerHTML = "";
        rows.forEach((row, idx) => {
          row.serial = idx; // Update indices
          addRowToTable(row);
        });

        updateTotalAllocation();
        enableNextButton(rows);
      }
    });
    // *** CHANGE: Event listeners for real-time validation ***
    industryInput.addEventListener("change", validateIndustry);
    allocationInput.addEventListener("input", validateAllocation);
    unitSelect.addEventListener("change", validateUnit);
    // END Dynamic table creation and deletion

    nextButton.addEventListener('click', (event)=> {
      event.preventDefault(); // Prevent the default button behavior
      toggleSpinner();
      url = "{{url_for('desktop.industry')}}";
      payload = rows;
      fetch(url,{
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
      }).then(response => {
          if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
      .then(data => {
          // toggleSpinner();
          window.location.href=data['redirect_to'];
      })
      .catch(error => {
          toggleSpinner();
          console.error('Error:', error);
      });
    });
</script>
{%endblock%}